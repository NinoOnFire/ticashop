{% extends 'dashboard/base_dashboard.html' %}
{% load humanize %}

{% block title %}Listado de Facturas{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-receipt"></i> Listado de Facturas</h2>
    <a href="{% url 'ventas:listar_pedidos' %}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Volver a Pedidos
    </a>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-dark text-white">Facturas emitidas</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead class="table-dark">
            <tr>
              <th>Folio</th>
              <th>Cliente</th>
              <th>Vendedor</th>
              <th>Fecha Emisión</th>
              <th>Fecha Vencimiento</th>
              <th>Estado</th>
              <th class="text-end">Total</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for f in facturas %}
              <tr>
                <td>#{{ f.folio }}</td>
                <td>{{ f.cliente.razon_social }}</td>
                <td>
                  {% if f.vendedor %}
                    {{ f.vendedor.get_full_name|default:f.vendedor.username }}
                  {% else %}
                    <span class="text-muted">No asignado</span>
                  {% endif %}
                </td>
                <td>
                  {% if f.fecha_emision %}
                    {{ f.fecha_emision|date:"d/m/Y" }}
                  {% else %}
                    <span class="text-muted">Sin emisión</span>
                  {% endif %}
                </td>
                <td>
                  {% if f.fecha_vencimiento %}
                    {{ f.fecha_vencimiento|date:"d/m/Y" }}
                  {% else %}
                    <span class="text-muted">Sin vencimiento</span>
                  {% endif %}
                </td>
                <td>
                  {% if f.nc_count and f.nc_count > 0 %}
                    <span class="badge bg-danger">DEVUELTO</span>
                  {% else %}
                    {% if f.esta_vencida %}
                      <span class="badge bg-danger">Vencida</span>
                    {% else %}
                      <span class="badge 
                        {% if f.estado == 'Emitida' %}bg-primary
                        {% elif f.estado == 'Pagada' %}bg-success
                        {% elif f.estado == 'Pago Parcial' %}bg-warning text-dark
                        {% elif f.estado == 'Devuelta' %}bg-danger
                        {% elif f.estado == 'Devuelta Parcial' %}bg-warning text-dark
                        {% else %}bg-secondary{% endif %}">
                        {{ f.estado }}
                      </span>
                    {% endif %}
                  {% endif %}
                </td>
                <td class="text-end">${{ f.total|floatformat:0|intcomma }}</td>

                <!-- ACCIONES -->
                <td class="text-center">
                  <a href="{% url 'documentos:detalle_documento' f.id %}" class="btn btn-sm btn-primary">Ver</a>

                  {# Si ya hay NCs o factura está marcada como devuelta -> no mostrar crear NC #}
                  {% if f.nc_count and f.nc_count > 0 or f.estado == 'Devuelta' or f.estado == 'Devuelta Parcial' %}
                    {% if f.nc_count and f.nc_count > 0 %}
                      <a href="{% url 'documentos:detalle_nota_credito' f.notas_credito.last.id %}" class="btn btn-sm btn-info ms-1">
                        Ver NC ({{ f.nc_count }})
                      </a>
                    {% else %}
                      <span class="badge bg-danger ms-1">DEVUELTA</span>
                    {% endif %}
                  {% else %}
                    {# No hay NC: mostrar botón crear si está permitido por la lógica (plazo, etc.) #}
                    {% if f.puede_crear_nota %}
                      <a href="{% url 'documentos:crear_nota_credito' f.id %}" class="btn btn-sm btn-warning ms-1">Nota Crédito</a>
                    {% else %}
                      <button class="btn btn-sm btn-warning ms-1" disabled title="No disponible (fuera de plazo o factura inválida)">Nota Crédito</button>
                    {% endif %}
                  {% endif %}
                </td>

              </tr>
            {% empty %}
              <tr>
                <td colspan="8" class="text-center text-muted p-4">No hay facturas</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}