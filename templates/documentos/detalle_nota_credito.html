{% extends 'dashboard/base_dashboard.html' %}
{% load humanize %}
{% block title %}Nota de Crédito #{{ nota.id }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  {% if messages %}
    {% for m in messages %}
      <div class="alert alert-{{ m.tags }}">{{ m }}</div>
    {% endfor %}
  {% endif %}

  <div class="card">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between">
        <div>
          <h4>Nota de Crédito #{{ nota.id }}</h4>
          <div class="small text-muted">Factura asociada: #{{ nota.factura.folio }}</div>
          <div class="small text-muted">Emitida: {{ nota.fecha_emision|date:"d/m/Y" }}</div>
          <div class="mt-2"><strong>Usuario:</strong> {{ nota.usuario.get_full_name|default:nota.usuario.username }}</div>
        </div>

        <div class="text-end">
          <div class="fw-bold">Monto NC</div>
          <div class="h4 text-success">${{ nota.monto|floatformat:0|intcomma }}</div>
          <div class="mt-2">
            {% if nota.estado == 'Emitida' %}
              <span class="badge bg-info">{{ nota.estado }}</span>
            {% else %}
              <span class="badge bg-success">{{ nota.estado }}</span>
            {% endif %}
          </div>
        </div>
      </div>

      <hr>

      <div class="mb-3">
        <strong>Motivo:</strong>
        <div class="border p-2">{{ nota.motivo }}</div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>Producto</th>
              <th style="width:12%;">Cantidad</th>
              <th style="width:18%;">Precio unitario</th>
              <th style="width:18%;">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            {% for d in detalles %}
              <tr>
                <td>{% if d.producto %}{{ d.producto.nombre }}{% else %}{{ d.descripcion }}{% endif %}</td>
                <td class="text-center">{{ d.cantidad }}</td>
                <td class="text-end">${{ d.precio_unitario|floatformat:0|intcomma }}</td>
                <td class="text-end">${{ d.subtotal|floatformat:0|intcomma }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted">No hay detalles para esta nota.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-end mt-3">
        <div style="width:320px;">
          <div class="d-flex justify-content-between">
            <div>Total NC</div>
            <div class="text-end">${{ nota.monto|floatformat:0|intcomma }}</div>
          </div>
        </div>
      </div>

      <div class="mt-3 text-end">
        <a href="{% url 'documentos:detalle_documento' nota.factura.id %}" class="btn btn-secondary btn-sm">Volver a Factura</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}